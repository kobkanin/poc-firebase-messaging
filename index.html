<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <title>POC Firebase Messaging</title>
    <!-- PWA meta + manifest -->
    <meta name="theme-color" content="#0ea5e9" />
    <link rel="manifest" href="./manifest.json" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
          Helvetica, Arial, sans-serif;
        margin: 0;
        background: #f6f8fa;
      }
      .wrap {
        max-width: 820px;
        margin: 40px auto;
        padding: 24px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      }
      .btn {
        display: inline-block;
        margin-top: 12px;
        padding: 10px 14px;
        border-radius: 8px;
        background: #0ea5e9;
        color: #fff;
        border: none;
        cursor: pointer;
      }
      .token-box {
        margin-top: 12px;
        padding: 12px;
        border: 1px dashed #cbd5e1;
        border-radius: 8px;
        background: #f8fafc;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        word-break: break-all;
      }
      .token-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }
      .muted {
        color: #64748b;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h2>FCM</h2>
      <button id="btnToken" class="btn">Show FCM Token</button>
      <div id="tokenBox" class="token-box" hidden>
        <div class="muted">FCM Token:</div>
        <div id="tokenText">-</div>
        <div class="token-actions">
          <button id="btnCopy" class="btn" style="background: #16a34a">
            Copy
          </button>
          <button id="btnHide" class="btn" style="background: #475569">
            Hide
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
      import {
        getMessaging,
        getToken,
        onMessage,
      } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-messaging.js";

      // ---- Base path สำหรับ GitHub Pages: https://<user>.github.io/<repo>/
      const parts = location.pathname.split("/").filter(Boolean); // ["poc-firebase-messaging", ...]
      const BASE = parts.length ? `/${parts[0]}/` : "/";
      const SW_PATH = `${BASE}firebase-messaging-sw.js`;

      const firebaseConfig = {
        apiKey: "AIzaSyBEYRc3lWgrhf3JuzBVOI33sdelL53xuuk",
        authDomain: "onerev-dev.firebaseapp.com",
        projectId: "onerev-dev",
        storageBucket: "onerev-dev.firebasestorage.app",
        messagingSenderId: "782528078431",
        appId: "1:782528078431:web:ccd3e92370c8e316c531ea",
      };

      const VAPID_KEY =
        "BFCv-L3AhpTkUvrUyGYLHpSv-CnSI0Nla7XaafAU4TqyXXfCZJrtrzScBMhFFfjryDZsPg0Ew8qKywXfLt_bYIg";

      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register(`${BASE}sw.js`, { scope: BASE })
          .then((r) => console.log("[PWA] registered", r.scope))
          .catch((err) => console.error("[PWA] registration failed", err));
      }

      const app = initializeApp(firebaseConfig);
      const m = getMessaging(app);

      const btn = document.getElementById("btnToken");
      const btnCopy = document.getElementById("btnCopy");
      const btnHide = document.getElementById("btnHide");
      const tokenBox = document.getElementById("tokenBox");
      const tokenText = document.getElementById("tokenText");

      // default options เฉพาะใช้ตอน onMessage เพื่อ preview
      const notificationOptions = {
        body: "Hello from FCM!",
        icon: `${BASE}icon-192.png`,
        badge: `${BASE}icon-192.png`,
        tag: "demo",
        data: { link_url: `${BASE}` },
      };

      btn.addEventListener("click", async () => {
        try {
          btn.disabled = true;
          btn.textContent = "Loading...";

          if (Notification.permission !== "granted") {
            await Notification.requestPermission();
          }
          if (Notification.permission !== "granted") {
            alert("ต้องอนุญาตการแจ้งเตือนก่อนนะครับ");
            return;
          }

          // จดทะเบียน SW ด้วย scope ถูกต้อง (กัน Firebase ไปจดทะเบียนที่รากโดเมน)
          const reg = await navigator.serviceWorker.register(SW_PATH, {
            scope: BASE,
          });
          await reg.update();

          const currentToken = await getToken(m, {
            vapidKey: VAPID_KEY,
            serviceWorkerRegistration: reg, // **จุดสำคัญ**
          });

          if (currentToken) {
            console.log("[FCM] token:", currentToken);
            tokenText.textContent = currentToken;
            tokenBox.hidden = false;
          } else {
            alert(
              "ยังไม่ได้รับ token (อาจถูกบล็อก permission หรือ browser ไม่รองรับ)"
            );
          }
        } catch (e) {
          console.error("Get token failed:", e);
          alert("Get token failed: " + (e?.message || e));
        } finally {
          btn.disabled = false;
          btn.textContent = "Show FCM Token";
        }
      });

      btnCopy.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(tokenText.textContent.trim());
          btnCopy.textContent = "Copied!";
          setTimeout(() => (btnCopy.textContent = "Copy"), 1200);
        } catch {
          alert("คัดลอกไม่สำเร็จ");
        }
      });

      btnHide.addEventListener("click", () => (tokenBox.hidden = true));

      // รับข้อความตอน foreground → แสดงผ่าน SW (ถ้า payload มี notification ก็ไม่ซ้ำ)
      onMessage(m, (payload) => {
        console.log("[FCM] foreground:", payload);
        if (payload?.notification) return; // ป้องกันซ้ำถ้าฝั่งส่งเผลอแนบ notification มา

        const data = payload?.data || {};
        const { title = "Message", link_url, ...rest } = data;
        const opts = {
          ...notificationOptions,
          ...rest,
          data: { link_url: link_url || notificationOptions.data.link_url },
        };
        navigator.serviceWorker.ready.then((reg) =>
          reg.showNotification(title, opts)
        );
      });
    </script>
  </body>
</html>
